<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="{{ app_name }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ja.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        :root {
            --primary-color: {{ theme_color }};
        }
    </style>
    
    <title>{{ app_name }}</title>
</head>
<body>
    <header class="fixed-header">
        <div class="header-main">
            <div class="header-left-group">
                <button id="sidebar-toggle" class="sidebar-toggle">☰</button>
                <h1>{{ app_name }}</h1>
            </div>
            <div id="current-time" class="header-time">--/-- (--) --:--:--</div>
        </div>
        {% if mode == 'admin' %}
        <div class="header-controls">
            <div class="report-section">
                <input type="text" id="report-period" placeholder="期間を選択">
                <button id="create-report-btn" class="header-btn">集計レポート作成</button>
            </div>
            <div class="nav-buttons">
                <button onclick="location.href='/?mode=edit&return_mode={{ mode }}'" class="header-btn">記録編集</button>
            </div>
        </div>
        {% endif %}

        <section class="manual-entry-form">
            <h2>手動で入退室</h2>
            <div class="entry-container">
                <div class="selectors">
                    <div class="selector-item">
                        <label for="grade-select">学年</label>
                        <select id="grade-select" class="styled-select"></select>
                    </div>
                    <div class="selector-item">
                        <label for="class-select">組</label>
                        <select id="class-select" class="styled-select" disabled></select>
                    </div>
                    <div class="selector-item">
                        <label for="number-select">番号</label>
                        <select id="number-select" class="styled-select" disabled></select>
                    </div>
                    <div class="selector-item" id="seat-selector-item" style="display: none;">
                        <label for="seat-select">座席</label> <select id="seat-select" class="styled-select"></select>
                    </div>
                    <div class="selector-item" id="student-name-container" style="display: none;">
                        <label>氏名</label> <div id="student-name-display" class="student-name"></div>
                    </div>
                </div>
                <div id="action-button-container"></div>
            </div>
        </section>

        <div class="list-header">
            {% if mode == 'admin' %}
                <h2>本日の入室者リスト</h2>
                <button id="exit-all-btn" class="danger-btn">全員退室</button>
            {% elif mode == 'scanner' %}
                <h2>本日の入室者リスト</h2>
                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <button id="exit-all-btn" class="danger-btn">全員退室</button>
                    <button onclick="location.href='/?mode=edit&return_mode={{ mode }}'" class="header-btn">記録編集</button>
                    <button id="open-camera-btn" class="header-btn">QRスキャン</button>
                </div>
            {% else %}
                <h2>手動入室者リスト</h2>
            {% endif %}
        </div>
    </header>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>自習室業務支援システム</h2>
            <button id="sidebar-close" class="sidebar-close">×</button>
        </div>
        
        <div class="sidebar-status-card">
            <div class="status-item">
                <span class="status-label">現在のモード:</span>
                <span class="status-value mode-badge" id="sidebar-mode-display">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">ネットワーク:</span>
                <span class="status-value" id="sidebar-network-status"><span class="status-dot"></span> <span id="network-text">判定中</span></span>
            </div>
            <div class="status-item">
                <span class="status-label">サーバー通信:</span>
                <span class="status-value" id="sidebar-server-status">待機中</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="/" class="active">入退室管理システム</a>
                    <ul class="sidebar-sub-nav">
                        <li><a href="/?mode=students" class="{% if mode == 'students' or not mode %}active-mode{% endif %}">通常モード (生徒用)</a></li>
                        <li><a href="/?mode=scanner" class="{% if mode == 'scanner' %}active-mode{% endif %}">スキャナーモード</a></li>
                        <li><a href="/?mode=admin" class="{% if mode == 'admin' %}active-mode{% endif %}">管理者モード</a></li>
                    </ul>
                </li>
                <li><a href="/qna/">質問管理システム</a></li>
            </ul>
        </nav>

        <div class="sidebar-actions">
            <button id="open-settings-btn" class="sidebar-action-btn">⚙ システム設定</button>
        </div>

        <div class="sidebar-footer">
            <p>Version 1.1.0</p>
            <p>&copy; 2026 Codeswitcher Co.,Ltd.</p>
        </div>
    </aside>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div id="settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>システム設定</h2>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">※変更を反映するにはサーバー再起動が必要な場合があります。</p>
            <form id="settings-form">
                <div class="form-group">
                    <label>アプリケーション名</label>
                    <input type="text" name="APP_NAME" placeholder="入退室管理システム">
                </div>
                <div class="form-group">
                    <label>組織名 (日本語)</label>
                    <input type="text" name="ORGANIZATION_NAME" placeholder="〇〇塾">
                </div>
                <div class="form-group">
                    <label>組織名 (英語/Copyright用)</label>
                    <input type="text" name="ORGANIZATION_NAME_ENG" placeholder="Organization Inc.">
                </div>
                <div class="form-group">
                    <label>最大座席数</label>
                    <input type="number" name="MAX_SEAT_NUMBER" placeholder="72">
                </div>
                <div class="form-group">
                    <label>テーマカラー</label>
                    <input type="color" name="THEME_COLOR" value="{{ theme_color }}">
                </div>
                <div class="modal-actions">
                    <button type="button" id="close-settings-btn">キャンセル</button>
                    <button type="submit" class="enter-btn">保存</button>
                </div>
            </form>
        </div>
    </div>

    <main>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>学年</th>
                        <th>組</th>
                        <th>番号</th>
                        <th>座席</th>
                        <th>氏名</th>
                        <th>入室</th>
                        <th>滞在時間</th>
                        <th>退室</th>
                    </tr>
                </thead>
                <tbody id="attendance-table-body">
                </tbody>
            </table>
        </div>
    </main>

    <footer class="app-footer">
        <small>&copy; {{ org_name_eng }} All Rights Reserved.</small>
    </footer>

    {% if mode == 'admin' %}
        <input type="text" id="qr-input" class="qr-input-hidden" autocomplete="off">
    {% endif %}

    <div id="camera-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content camera-modal-content">
            <h2>QRコードをスキャン</h2>
            <div class="camera-wrapper">
                <video id="camera-video" playsinline muted></video>
                <canvas id="camera-canvas" style="display: none;"></canvas>
                <div class="scan-guide"></div>
            </div>
            <p>カメラをQRコードに向けてください</p>
            <div class="modal-actions">
                <button id="close-camera-btn" class="danger-btn">閉じる</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <body data-app-mode="{{ mode }}" data-max-seat-number="{{ max_seat_number }}">
    <script>
        // HTML要素からデータを取得
        const body = document.body;
        const APP_MODE = body.dataset.appMode;
        const MAX_SEAT_NUMBER = parseInt(body.dataset.maxSeatNumber, 10);
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
 <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // service-worker.js は static フォルダ直下に配置してください
                navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });

                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');
                
                // PWA（ホーム画面から）起動されたかどうかを判定
                const isPWA = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

                // URLにモードが指定されている場合は、そのモードを「お気に入り」として保存
                if (mode) {
                    localStorage.setItem('preferred_mode', mode);
                } 
                // モード指定がない（PWA起動など）かつ、過去に保存されたモードがある場合は復元
                else if (isPWA) {
                    const savedMode = localStorage.getItem('preferred_mode');
                    if (savedMode && savedMode !== 'students') {
                        window.location.href = '/?mode=' + savedMode;
                        return;
                    }
                }

                const isIOS = /iPhone|iPod/.test(userAgent) && !window.MSStream;
                const isIPad = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 0) || /iPad/.test(userAgent);

                if ((isIOS || isIPad) && !mode) {
                    console.log("iOS/iPadOS device detected. Staying in students mode.");
                } 
                else if (mode !== 'admin' && mode !== 'scanner' && mode !== 'students') {
                    console.log("PC device detected. Redirecting to admin mode.");
                    window.location.href = '/?mode=admin';
                }
            });
        }
    </script>
</body>
</html>